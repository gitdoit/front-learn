<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>多级表头excel导出</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
</head>

<body>
  <div id="app">
    <el-button @click="exportData">导出</el-button>
    <el-table @selection-change="handleSelectionChange" :data="list" style="width: 100%" size="mini">
      <el-table-column type="selection" width="55"></el-table-column>
      <el-table-column label="姓名" prop="name" align="center"></el-table-column>
      <el-table-column label="专业技能" align="center">
        <el-table-column label="前端" align="center">
          <el-table-column label="JavaScript" prop="js" align="center"></el-table-column>
          <el-table-column label="CSS" prop="css" align="center"></el-table-column>
        </el-table-column>
        <el-table-column label="后端" align="center">
          <el-table-column label="java" align="center">
            <el-table-column label="nio" prop="nio" align="center"></el-table-column>
            <el-table-column label="基础" prop="basic" align="center"></el-table-column>
          </el-table-column>
          <el-table-column label="框架" align="center">
            <el-table-column label="SpringBoot" prop="springboot" align="center"></el-table-column>
            <el-table-column label="MyBatis" prop="mybatis" align="center"></el-table-column>
          </el-table-column>
        </el-table-column>
      </el-table-column>
    </el-table>
  </div>
  <script src="https://unpkg.com/vue/dist/vue.js"></script>
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>

  <script src="lib/style/xlsx.full.min.js"></script>
  <script>
    const app = new Vue({
      el: "#app",
      data() {
        return {
          selectionData: [],
          list: [
            { name: '张三', js: '熟练', css: '一般', nio: '了解', basic: '精通', springboot: '熟练', mybatis: '了解' },
            { name: '张三', js: '熟练', css: '一般', nio: '了解', basic: '精通', springboot: '熟练', mybatis: '了解' },
            { name: '张三', js: '熟练', css: '一般', nio: '了解', basic: '精通', springboot: '熟练', mybatis: '了解' },
            { name: '张三', js: '熟练', css: '一般', nio: '了解', basic: '精通', springboot: '熟练', mybatis: '了解' },
          ],
          revealList: [
            {
              name: '姓名',
              prop: 'name',
            },
            {
              name: '专业技能',
              child: [
                {
                  name: '前端',
                  child: [
                    {
                      name: 'JavaScript',
                      prop: 'js'
                    },
                    {
                      name: 'CSS',
                      prop: 'css'
                    }
                  ]
                },
                {
                  name: '后端',
                  child: [
                    {
                      name: 'java',
                      child: [
                        {
                          name: 'nio',
                          prop: 'nio'
                        },
                        {
                          name: '基础',
                          prop: 'basic'
                        }
                      ]
                    },
                    {
                      name: '框架',
                      child: [
                        {
                          name: 'SpringBoot',
                          prop: 'springboot'
                        },
                        {
                          name: 'MyBatis',
                          prop: 'mybatis'
                        }
                      ]
                    }
                  ]
                },
              ]
            },
          ],
        }
      },
      methods: {
        handleSelectionChange(selection) {
          this.selectionData = selection
        },
        exportData() {
          let sheetName = '多级表头excel'
          let excelHeader = [[], [], []];

          this.getHeader(this.revealList, excelHeader, 0, 0);
          this.fillNull(excelHeader);
          let merges = this.doMerges(excelHeader)
          let dataList = this.extractData(this.selectionData, this.revealList)
          excelHeader.push(...dataList)
          let ws = this.aoa_to_sheet(excelHeader);
          ws['!merges'] = merges;
          ws['!freeze'] = {
            xSplit: "1",
            ySplit: "3",
            topLeftCell: "B4",
            activePane: "bottomRight",
            state: "frozen",
          }
          let workbook = {
            SheetNames: [sheetName],
            Sheets: {}
          };
          workbook.Sheets[sheetName] = ws;
          // excel样式
          let wopts = { bookType: 'xlsx', bookSST: false, type: 'binary', cellStyles: true };
          let wbout = XLSX.write(workbook, wopts);
          let blob = new Blob([this.s2ab(wbout)], { type: "application/octet-stream" });
          this.openDownloadXLSXDialog(blob, sheetName + '.xlsx')
        },
        getHeader(headers, excelHeader, deep, perOffset) {
          let offset = 0
          let cur = excelHeader[deep]
          if (!cur) {
            cur = excelHeader[deep] = []
          }
          this.pushUndefined(cur, perOffset - cur.length)
          for (let i = 0; i < headers.length; i++) {
            let head = headers[i]
            cur.push(head.name)
            if (head.hasOwnProperty('child') && Array.isArray(head.child) && head.child.length > 0) {
              let childOffset = this.getHeader(head.child, excelHeader, deep + 1, cur.length - 1)
              this.pushNull(cur, childOffset - 1)
              offset += childOffset
            } else {
              offset++
            }
          }
          return offset;
        },
        pushUndefined(arr, count) {
          for (let i = 0; i < count; i++) {
            arr.push(undefined)
          }
        },
        pushNull(arr, count) {
          for (let i = 0; i < count; i++) {
            arr.push(null)
          }
        },
        fillNull(arr) {
          let max = Math.max(...(arr.map(a => a.length)))
          arr.filter(e => e.length < max).forEach(e => pushNull(e, max - e.length))
        },
        extractData(selectionData, revealList) {
          let headerList = [];
          this.flat(revealList, headerList);
          // 结果集
          let result = [];
          selectionData.forEach(row => {
            let rowData = []
            headerList.forEach(prop => {
              let value = null;
              if (typeof prop === 'function') {
                value = prop(row);
              } else {
                value = row[prop];
              }
              value = (value === null || value === undefined) ? '' : value
              rowData.push(value)
            })
            result.push(rowData)
          })
          return result
        },
        flat(revealList, result) {
          revealList.forEach(e => {
            if (e.hasOwnProperty('child')) {
              this.flat(e.child, result)
            } else if (e.hasOwnProperty('exeFun')) {
              result.push(e.exeFun)
            } else if (e.hasOwnProperty('prop')) {
              result.push(e.prop)
            }
          })
        },
        doMerges(arr) {
          // 要么横向合并 要么纵向合并
          let deep = arr.length;
          let merges = [];
          for (let y = 0; y < deep; y++) {
            // 先处理横向合并
            let row = arr[y];
            let colSpan = 0
            for (let x = 0; x < row.length; x++) {
              if (row[x] === null) {
                colSpan++
                if (((x + 1) === row.length) && (colSpan > 0 && x > colSpan)) {
                  merges.push({ s: { r: y, c: x - colSpan }, e: { r: y, c: x } })
                }
              } else if (colSpan > 0 && x > colSpan) {
                merges.push({ s: { r: y, c: x - colSpan - 1 }, e: { r: y, c: x - 1 } })
                colSpan = 0
              } else {
                colSpan = 0
              }
            }
          }
          // 再处理纵向合并
          let colLength = arr[0].length
          for (let x = 0; x < colLength; x++) {
            let rowSpan = 0
            for (let y = 0; y < deep; y++) {
              if (arr[y][x] != null) {
                rowSpan = 0
              } else {
                rowSpan++;
              }
            }
            if (rowSpan > 0) {
              merges.push({ s: { r: deep - rowSpan - 1, c: x }, e: { r: deep - 1, c: x } })
            }
          }
          return merges;
        },
        aoa_to_sheet(data) {
          const ws = {};
          const range = { s: { c: 10000000, r: 10000000 }, e: { c: 0, r: 0 } };
          for (let R = 0; R !== data.length; ++R) {
            for (let C = 0; C !== data[R].length; ++C) {
              if (range.s.r > R) range.s.r = R;
              if (range.s.c > C) range.s.c = C;
              if (range.e.r < R) range.e.r = R;
              if (range.e.c < C) range.e.c = C;
              /// 这里生成cell的时候，使用上面定义的默认样式
              const cell = {
                v: data[R][C], s: {
                  font: { name: "宋体", sz: 11, color: { auto: 1 } },
                  border: {
                    top: { style: 'thin', color: { rgb: "000000" } },
                    left: { style: 'thin', color: { rgb: "000000" } },
                    bottom: { style: 'thin', color: { rgb: "000000" } },
                    right: { style: 'thin', color: { rgb: "000000" } },
                  },
                  fill: {
                    patternType: 'solid',
                    fgColor: { theme: 3, "tint": 0.3999755851924192, rgb: 'DDD9C4' },
                    bgColor: { theme: 7, "tint": 0.3999755851924192, rgb: '8064A2' }
                  },
                  alignment: {
                    /// 自动换行
                    wrapText: 1,
                    // 居中
                    horizontal: "center",
                    vertical: "center",
                    indent: 0
                  }
                }
              };
              // if (cell.v == null) continue;
              const cell_ref = XLSX.utils.encode_cell({ c: C, r: R });
              if (typeof cell.v === 'number') cell.t = 'n';
              else if (typeof cell.v === 'boolean') cell.t = 'b';
              else cell.t = 's';
              ws[cell_ref] = cell;
            }
          }
          if (range.s.c < 10000000) ws['!ref'] = XLSX.utils.encode_range(range);
          return ws;
        },
        s2ab(s) {
          var buf = new ArrayBuffer(s.length);
          var view = new Uint8Array(buf);
          for (var i = 0; i != s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;
          return buf;
        },
        openDownloadXLSXDialog(url, saveName) {
          if (typeof url == 'object' && url instanceof Blob) {
            url = URL.createObjectURL(url); // 创建blob地址
          }
          var aLink = document.createElement('a');
          aLink.href = url;
          aLink.download = saveName || ''; // HTML5新增的属性，指定保存文件名，可以不要后缀，注意，file:///模式下不会生效
          var event;
          if (window.MouseEvent) event = new MouseEvent('click');
          else {
            event = document.createEvent('MouseEvents');
            event.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
          }
          aLink.dispatchEvent(event);
        }
      }
    })
  </script>
</body>

</html>